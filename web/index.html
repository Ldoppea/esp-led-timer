<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timer Control</title>
</head>
<body>
  <fieldset id="state" disabled>
    <legend>Timer Control</legend>
    <p>
      <label for="mode">Mode:</label>
      <select id="mode">
        <option value="1">Timer 1</option>
        <option value="2">Timer 2</option>
        <option value="3" disabled>Timer 2</option>
        <option value="0">Logo</option>
        <option value="-1" disabled>Info</option>
        <option value="-2" disabled>Message</option>
      </select>
    </p>
    <h1 id="timer">00:00:00</h1>
    <p>
      <button id="timer_start">Start</button>
      <button id="timer_stop">Stop</button>
      <button id="timer_reset">Reset</button>
    </p>
    <p>
      <label for="brightness">Brightness:</label>
      <input type="range" id="brightness" min="4" max="255">
      <button id="default_brightness">Default</button>
    </p>
  </fieldset>

  <script>
    let config;
    let state;
    let update_timer = undefined;
    let update_timer_sim = undefined

    async function getConfig() {
      const response = await fetch('/config');
      config = await response.json();
    }

    function updateTimer(time) {
      const hours = String(Math.floor(time / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((time - hours * 3600) / 60)).padStart(2, '0');
      const seconds = String(time - hours * 3600 - minutes * 60).padStart(2, '0');
      document.getElementById('timer').innerText = `${hours}:${minutes}:${seconds}`;
    }

    async function getState() {
      const response = await fetch('/state');
      state = await response.json();
      updateTimer(state.time);
      document.getElementById('mode').value = state.mode;
      document.getElementById('brightness').value = state.brightness;

      if (state.timer_started && !update_timer) {
        // Simulate timer
        update_timer_sim = setInterval(() => {
          state.time -= 1;
          updateTimer(state.time);
        }, 1000);
        // Sync with real timer every 10 seconds
        update_timer = setInterval(async () => {
          await getState();
          updateTimer(state.time);
        }, 10000);
      } else if (!state.timer_started) {
        clearInterval(update_timer_sim);
        clearInterval(update_timer);
        update_timer = undefined;
      }
      document.getElementById('timer_start').disabled = state.timer_started;
      document.getElementById('timer_stop').disabled = !state.timer_started;
    }

    async function sendState(key, value) {
      const form = new FormData();
      form.append(key, value);
      const response = await fetch('/state', {
        method: 'POST',
        body: form
      });
      if (!response.ok) {
        alert(`Failed to set ${key}`);
      }
      await getState();
    }

    window.onload = async () => {
      await getConfig();
      await getState();
      document.getElementById('state').disabled = false;

      document.getElementById('mode').onchange = async () => {
        const mode = document.getElementById('mode').value;
        await sendState('mode', mode);
      };
      document.getElementById('brightness').onchange = async () => {
        const brightness = document.getElementById('brightness').value;
        await sendState('brightness', brightness);
      };
      document.getElementById('timer_start').onclick = async () => {
        await sendState('timer_start', true);
      };
      document.getElementById('timer_stop').onclick = async () => {
        await sendState('timer_stop', true);
      };
      document.getElementById('timer_reset').onclick = async () => {
        await sendState('timer_reset', true);
      };
      document.getElementById('default_brightness').onclick = async () => {
        document.getElementById('brightness').value = config.brightness;
        await sendState('brightness', config.brightness);
      };
    };
  </script>
</body>
</html>
